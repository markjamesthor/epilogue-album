<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <title>Epilogue Album</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: { gold: { 400: '#d4a853', 500: '#c4a35a', 600: '#a8872e' } }
        }
      }
    }
  </script>
  <style>
    body { overscroll-behavior: none; }
    .frame-zone {
      position: absolute;
      overflow: hidden;
      z-index: 1;
      transition: box-shadow 0.25s, transform 0.25s, filter 0.25s;
    }
    .frame-zone.selected {
      box-shadow: 0 0 0 4px rgba(212, 168, 83, 1), 0 0 20px rgba(212, 168, 83, 0.6);
      transform: scale(1.12);
      z-index: 8 !important;
      filter: brightness(1.15);
    }
    .frame-zone.drop-target {
      box-shadow: 0 0 0 3px rgba(212, 168, 83, 0.5);
    }
    .frame-zone img.photo {
      width: 100%; height: 100%;
      object-fit: cover;
      pointer-events: none;
      display: block;
    }
    .frame-overlay {
      position: absolute;
      inset: 0;
      width: 100%; height: 100%;
      pointer-events: none;
      z-index: 5;
    }
    .drag-ghost {
      position: fixed;
      pointer-events: none;
      z-index: 1000;
      opacity: 0.85;
      transform: translate(-50%, -50%) scale(0.5);
      border-radius: 8px;
      box-shadow: 0 12px 40px rgba(0,0,0,0.6);
      transition: opacity 0.15s;
    }
    .placeholder-icon {
      width: 100%; height: 100%;
      display: flex; align-items: center; justify-content: center;
      background: rgba(0,0,0,0.25);
      backdrop-filter: blur(2px);
    }
    @keyframes fadeIn { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }
    .animate-in { animation: fadeIn 0.3s ease-out; }
    @keyframes toastIn { from { opacity: 0; transform: translate(-50%, 10px); } to { opacity: 1; transform: translate(-50%, 0); } }
    @keyframes toastOut { from { opacity: 1; transform: translate(-50%, 0); } to { opacity: 0; transform: translate(-50%, -10px); } }
    .toast {
      position: fixed; left: 50%; z-index: 200;
      transform: translateX(-50%);
      animation: toastIn 0.25s ease-out;
    }
    .toast.hide { animation: toastOut 0.25s ease-in forwards; }
  </style>
</head>
<body class="bg-gray-950 min-h-screen flex flex-col select-none">

  <!-- Header -->
  <header class="sticky top-0 z-50 bg-gray-950/90 backdrop-blur-md border-b border-gray-800/60 px-4 py-3 flex items-center justify-between"
          style="padding-top: max(12px, env(safe-area-inset-top))">
    <h1 class="text-lg font-semibold text-gold-400 tracking-widest">Epilogue Album</h1>
    <button id="upload-btn"
            class="bg-gold-500 hover:bg-gold-600 active:scale-95 text-white px-4 py-2 rounded-full text-sm font-medium transition-all shadow-lg shadow-gold-500/20">
      여러장 한번에 올리기
    </button>
  </header>

  <!-- Album Pages -->
  <main id="album" class="flex-1 overflow-y-auto px-4 py-5 space-y-5">
    <p id="loading-msg" class="text-center text-gray-500 py-20">로딩 중...</p>
  </main>

  <!-- Footer -->
  <footer class="sticky bottom-0 z-50 bg-gray-950/90 backdrop-blur-md border-t border-gray-800/60 px-4 py-3 flex items-center justify-center gap-3"
          style="padding-bottom: max(12px, env(safe-area-inset-bottom))">
    <span id="hint-text" class="text-xs text-gray-500 hidden">사진을 탭하여 선택 후 다른 액자를 탭하면 교체</span>
    <button id="add-page-btn"
            class="bg-gray-800 hover:bg-gray-700 active:scale-95 text-gold-400 border border-gold-500/30 px-6 py-2.5 rounded-full text-sm font-medium transition-all">
      앨범 페이지 추가
    </button>
  </footer>

  <!-- Frame Picker -->
  <div id="frame-picker" class="fixed inset-0 z-[100] hidden">
    <div class="absolute inset-0 bg-black/50" id="picker-backdrop"></div>
    <div class="absolute bottom-0 left-0 right-0 bg-gray-900 rounded-t-2xl" style="padding-bottom: max(20px, env(safe-area-inset-bottom))">
      <div class="w-10 h-1 bg-gray-600 rounded-full mx-auto mt-3 mb-4"></div>
      <p class="text-center text-gray-400 text-sm mb-4">추가할 페이지를 선택하세요</p>
      <div class="flex flex-col gap-3 px-5 pb-4">
        <button data-template="0" class="picker-opt bg-gray-800 hover:bg-gray-700 active:scale-[0.98] text-white py-3.5 rounded-xl text-sm font-medium transition-all border border-gray-700">액자 1개</button>
        <button data-template="1" class="picker-opt bg-gray-800 hover:bg-gray-700 active:scale-[0.98] text-white py-3.5 rounded-xl text-sm font-medium transition-all border border-gray-700">액자 2개</button>
        <button data-template="2" class="picker-opt bg-gray-800 hover:bg-gray-700 active:scale-[0.98] text-white py-3.5 rounded-xl text-sm font-medium transition-all border border-gray-700">액자 3개</button>
      </div>
    </div>
  </div>

  <!-- Hidden file inputs -->
  <input type="file" id="file-input" accept="image/*" multiple hidden>
  <input type="file" id="single-file-input" accept="image/*" hidden>

  <!-- Drag ghost -->
  <div id="drag-ghost" class="drag-ghost hidden">
    <img class="w-24 h-24 object-cover rounded-lg">
  </div>

<script>
// ========================================
// Configuration
// ========================================
const FRAME_TEMPLATES = [
  {
    src: 'album_images/u9138982156_technical_flat_front_elevation_view_perfectly_strai_91d7e992-9a33-49b8-8d7e-2ca1113428b1.webp',
    width: 2592, height: 1824,
    regions: [
      { x: 943, y: 532, w: 569, h: 808 },
    ]
  },
  {
    src: 'album_images/u9138982156_technical_flat_front_elevation_view_perfectly_strai_5f847c61-c36d-499c-8cec-331b46d0fbce.webp',
    width: 2592, height: 1824,
    regions: [
      { x: 830, y: 815, w: 335, h: 499 },
      { x: 1506, y: 968, w: 300, h: 370 },
    ]
  },
  {
    src: 'album_images/u9138982156_technical_flat_front_elevation_view_perfectly_strai_3b45b181-f6a9-4a0d-88a4-651f071943ad.webp',
    width: 2592, height: 1824,
    regions: [
      { x: 407, y: 772, w: 274, h: 426 },
      { x: 1078, y: 663, w: 287, h: 450 },
      { x: 1793, y: 779, w: 261, h: 434 },
    ]
  }
];

let pages = [0, 1, 2]; // indices into FRAME_TEMPLATES

function getTotalSlots() {
  return pages.reduce((s, pi) => s + FRAME_TEMPLATES[pi].regions.length, 0);
}

// ========================================
// State
// ========================================
let photos = [];
let photoURLs = [];
let selectedSlot = -1;
let frameImages = []; // Loaded frame Image objects (one per template)

// ========================================
// Helpers
// ========================================
function loadImage(src) {
  return new Promise((resolve, reject) => {
    const img = new Image();
    img.crossOrigin = 'anonymous';
    img.onload = () => resolve(img);
    img.onerror = reject;
    img.src = src;
  });
}

function loadImageFromFile(file) {
  return new Promise((resolve, reject) => {
    const url = URL.createObjectURL(file);
    const img = new Image();
    img.onload = () => resolve({ img, url });
    img.onerror = reject;
    img.src = url;
  });
}

function getGlobalSlotIndex(frameIdx, regionIdx) {
  let offset = 0;
  for (let i = 0; i < frameIdx; i++) offset += FRAMES[i].regions.length;
  return offset + regionIdx;
}

// ========================================
// UI Rendering
// ========================================
function renderAlbum() {
  const album = document.getElementById('album');
  album.innerHTML = '';

  let slotOffset = 0;
  pages.forEach((templateIdx, pi) => {
    const frame = FRAME_TEMPLATES[templateIdx];
    const page = document.createElement('div');
    page.className = 'relative w-full rounded-xl overflow-hidden shadow-2xl animate-in';
    page.style.aspectRatio = `${frame.width} / ${frame.height}`;

    // Frame zones (behind)
    frame.regions.forEach((region, ri) => {
      const slot = slotOffset + ri;
      const zone = document.createElement('div');
      zone.className = 'frame-zone cursor-pointer';
      zone.id = `slot-${slot}`;
      zone.dataset.slot = slot;
      zone.style.left = `${(region.x / frame.width * 100).toFixed(3)}%`;
      zone.style.top = `${(region.y / frame.height * 100).toFixed(3)}%`;
      zone.style.width = `${(region.w / frame.width * 100).toFixed(3)}%`;
      zone.style.height = `${(region.h / frame.height * 100).toFixed(3)}%`;

      renderSlotContent(zone, slot);
      setupSlotInteraction(zone, slot);
      page.appendChild(zone);
    });

    // Frame overlay (on top, transparent cutouts reveal photos)
    const overlay = document.createElement('img');
    overlay.src = frame.src;
    overlay.className = 'frame-overlay';
    overlay.draggable = false;
    page.appendChild(overlay);

    // Delete page button
    const delBtn = document.createElement('button');
    delBtn.className = 'absolute top-2 right-2 z-10 bg-black/50 hover:bg-black/70 active:scale-90 text-white/70 hover:text-white w-8 h-8 rounded-full flex items-center justify-center transition-all backdrop-blur-sm';
    delBtn.innerHTML = '<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>';
    delBtn.addEventListener('click', (e) => {
      e.stopPropagation();
      removePage(pi);
    });
    page.appendChild(delBtn);

    album.appendChild(page);
    slotOffset += frame.regions.length;
  });
}

function renderSlotContent(zone, slot) {
  if (photos[slot]) {
    zone.innerHTML = `<img class="photo" src="${photoURLs[slot]}" draggable="false">`;
  } else {
    zone.innerHTML = `
      <div class="placeholder-icon">
        <svg class="w-8 h-8 text-white/30" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M12 4.5v15m7.5-7.5h-15"/>
        </svg>
      </div>`;
  }
}

function refreshSlot(slot) {
  const zone = document.getElementById(`slot-${slot}`);
  if (zone) renderSlotContent(zone, slot);
}

function refreshAllSlots() {
  for (let i = 0; i < getTotalSlots(); i++) refreshSlot(i);
}

// ========================================
// Photo Upload
// ========================================
async function handleUpload(fileList) {
  const total = getTotalSlots();
  const files = Array.from(fileList).slice(0, total);
  let nextEmpty = 0;

  for (const file of files) {
    while (nextEmpty < total && photos[nextEmpty]) nextEmpty++;
    if (nextEmpty >= total) break;

    try {
      const { img, url } = await loadImageFromFile(file);
      photos[nextEmpty] = img;
      photoURLs[nextEmpty] = url;
      refreshSlot(nextEmpty);
      nextEmpty++;
    } catch (e) {
      console.error('Failed to load:', file.name, e);
    }
  }
  document.getElementById('hint-text').classList.remove('hidden');
}

// ========================================
// Slot Interaction (Tap to select + swap, Drag to swap)
// ========================================
function setupSlotInteraction(zone, slot) {
  let touchStartTime = 0;
  let touchStartX = 0, touchStartY = 0;
  let isDragging = false;
  let dragTimer = null;

  // --- Touch handlers ---
  zone.addEventListener('touchstart', (e) => {
    touchStartTime = Date.now();
    touchStartX = e.touches[0].clientX;
    touchStartY = e.touches[0].clientY;
    isDragging = false;

    if (photos[slot]) {
      dragTimer = setTimeout(() => {
        isDragging = true;
        startDrag(slot, touchStartX, touchStartY);
        if (navigator.vibrate) navigator.vibrate(30);
      }, 250);
    }
  }, { passive: true });

  zone.addEventListener('touchmove', (e) => {
    const dx = e.touches[0].clientX - touchStartX;
    const dy = e.touches[0].clientY - touchStartY;

    if (!isDragging && Math.sqrt(dx*dx + dy*dy) > 10) {
      clearTimeout(dragTimer);
    }

    if (isDragging) {
      e.preventDefault();
      moveDrag(e.touches[0].clientX, e.touches[0].clientY);
    }
  }, { passive: false });

  let touchHandled = false;
  zone.addEventListener('touchend', (e) => {
    clearTimeout(dragTimer);
    const elapsed = Date.now() - touchStartTime;

    if (isDragging) {
      endDrag(e.changedTouches[0].clientX, e.changedTouches[0].clientY);
    } else if (elapsed < 250) {
      handleTap(slot);
    }
    isDragging = false;
    touchHandled = true;
    setTimeout(() => { touchHandled = false; }, 300);
  });

  // --- Mouse fallback (for desktop testing) ---
  zone.addEventListener('click', () => {
    if (touchHandled) return;
    handleTap(slot);
  });
}

let pendingSlot = -1; // slot waiting for single photo upload
let toastTimer = null;

function showToast(msg) {
  // Remove existing toast
  const old = document.getElementById('toast');
  if (old) old.remove();
  clearTimeout(toastTimer);

  const el = document.createElement('div');
  el.id = 'toast';
  el.className = 'toast bg-gray-800/95 backdrop-blur-sm text-white text-sm px-5 py-2.5 rounded-full shadow-lg border border-gold-500/30';
  el.style.bottom = '100px';
  el.textContent = msg;
  document.body.appendChild(el);

  toastTimer = setTimeout(() => {
    el.classList.add('hide');
    setTimeout(() => el.remove(), 250);
  }, 2000);
}

function handleTap(slot) {
  // Empty slot: open file picker for this slot
  if (!photos[slot]) {
    if (selectedSlot !== -1) {
      // If another photo is selected, move it here
      swapPhotos(selectedSlot, slot);
      document.getElementById(`slot-${selectedSlot}`).classList.remove('selected');
      selectedSlot = -1;
    } else {
      pendingSlot = slot;
      document.getElementById('single-file-input').click();
    }
    return;
  }

  // Photo exists: select/deselect/swap
  if (selectedSlot === -1) {
    selectedSlot = slot;
    document.getElementById(`slot-${slot}`).classList.add('selected');
    showToast('이동할 액자를 선택하세요');
  } else if (selectedSlot === slot) {
    selectedSlot = -1;
    document.getElementById(`slot-${slot}`).classList.remove('selected');
  } else {
    swapPhotos(selectedSlot, slot);
    document.getElementById(`slot-${selectedSlot}`).classList.remove('selected');
    selectedSlot = -1;
    showToast('사진이 이동했습니다');
  }
}

function swapPhotos(a, b) {
  [photos[a], photos[b]] = [photos[b], photos[a]];
  [photoURLs[a], photoURLs[b]] = [photoURLs[b], photoURLs[a]];
  refreshSlot(a);
  refreshSlot(b);
}

// ========================================
// Drag & Drop
// ========================================
let dragState = null;

function startDrag(slot, x, y) {
  dragState = { slot };
  const ghost = document.getElementById('drag-ghost');
  ghost.querySelector('img').src = photoURLs[slot];
  ghost.classList.remove('hidden');
  ghost.style.left = x + 'px';
  ghost.style.top = y + 'px';

  // Dim source, highlight targets
  document.getElementById(`slot-${slot}`).style.opacity = '0.4';
  for (let i = 0; i < getTotalSlots(); i++) {
    if (i !== slot) {
      document.getElementById(`slot-${i}`).classList.add('drop-target');
    }
  }
}

function moveDrag(x, y) {
  const ghost = document.getElementById('drag-ghost');
  ghost.style.left = x + 'px';
  ghost.style.top = y + 'px';
}

function endDrag(x, y) {
  const ghost = document.getElementById('drag-ghost');
  ghost.classList.add('hidden');

  // Find target slot
  const els = document.elementsFromPoint(x, y);
  let targetSlot = null;
  for (const el of els) {
    if (el.dataset && el.dataset.slot !== undefined) {
      targetSlot = parseInt(el.dataset.slot);
      break;
    }
  }

  if (targetSlot !== null && targetSlot !== dragState.slot) {
    swapPhotos(dragState.slot, targetSlot);
  }

  // Clean up
  document.getElementById(`slot-${dragState.slot}`).style.opacity = '';
  for (let i = 0; i < getTotalSlots(); i++) {
    document.getElementById(`slot-${i}`).classList.remove('drop-target');
  }
  dragState = null;
}

// ========================================
// Download / Export
// ========================================
function drawCoverFit(ctx, img, x, y, w, h) {
  const iw = img.naturalWidth;
  const ih = img.naturalHeight;
  const scale = Math.max(w / iw, h / ih);
  const sw = w / scale;
  const sh = h / scale;
  const sx = (iw - sw) / 2;
  const sy = (ih - sh) / 2;
  ctx.drawImage(img, sx, sy, sw, sh, x, y, w, h);
}

async function downloadAll() {
  let slotOffset = 0;
  for (let pi = 0; pi < pages.length; pi++) {
    const frame = FRAME_TEMPLATES[pages[pi]];

    const pagePhotos = photos.slice(slotOffset, slotOffset + frame.regions.length);
    if (!pagePhotos.some(p => p !== null)) {
      slotOffset += frame.regions.length;
      continue;
    }

    const canvas = document.createElement('canvas');
    canvas.width = frame.width;
    canvas.height = frame.height;
    const ctx = canvas.getContext('2d');

    ctx.fillStyle = '#ffffff';
    ctx.fillRect(0, 0, canvas.width, canvas.height);

    for (let i = 0; i < frame.regions.length; i++) {
      const photo = photos[slotOffset + i];
      if (!photo) continue;
      const r = frame.regions[i];
      drawCoverFit(ctx, photo, r.x, r.y, r.w, r.h);
    }

    ctx.drawImage(frameImages[pages[pi]], 0, 0);

    const blob = await new Promise(r => canvas.toBlob(r, 'image/png'));
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `epilogue_album_page${pi + 1}.png`;
    document.body.appendChild(a);
    a.click();
    a.remove();
    URL.revokeObjectURL(url);

    slotOffset += frame.regions.length;
    await new Promise(r => setTimeout(r, 500));
  }
}

// ========================================
// Page Management
// ========================================
function removePage(pageIdx) {
  // Calculate slot offset for this page
  let slotOffset = 0;
  for (let i = 0; i < pageIdx; i++) slotOffset += FRAME_TEMPLATES[pages[i]].regions.length;
  const numSlots = FRAME_TEMPLATES[pages[pageIdx]].regions.length;

  // Remove page and its photo data
  pages.splice(pageIdx, 1);
  photos.splice(slotOffset, numSlots);
  photoURLs.splice(slotOffset, numSlots);

  // Clear selection
  selectedSlot = -1;

  renderAlbum();
}

function addPage(templateIdx) {
  pages.push(templateIdx);
  const numSlots = FRAME_TEMPLATES[templateIdx].regions.length;
  for (let i = 0; i < numSlots; i++) {
    photos.push(null);
    photoURLs.push(null);
  }
  renderAlbum();
  setTimeout(() => {
    const album = document.getElementById('album');
    album.lastElementChild.scrollIntoView({ behavior: 'smooth' });
  }, 100);
}

function showPicker() {
  document.getElementById('frame-picker').classList.remove('hidden');
}

function hidePicker() {
  document.getElementById('frame-picker').classList.add('hidden');
}

// ========================================
// Init
// ========================================
async function init() {
  try {
    // Preload frame template images
    for (const tmpl of FRAME_TEMPLATES) {
      const img = await loadImage(tmpl.src);
      frameImages.push(img);
    }

    // Initialize photo arrays for default pages
    const total = getTotalSlots();
    photos = new Array(total).fill(null);
    photoURLs = new Array(total).fill(null);

    renderAlbum();

    // Event listeners
    document.getElementById('upload-btn').addEventListener('click', () => {
      document.getElementById('file-input').click();
    });

    document.getElementById('file-input').addEventListener('change', (e) => {
      if (e.target.files.length > 0) {
        handleUpload(e.target.files);
      }
      e.target.value = '';
    });

    // Tap outside frames to deselect
    document.addEventListener('click', (e) => {
      if (selectedSlot === -1) return;
      if (e.target.closest('.frame-zone')) return;
      if (e.target.closest('#frame-picker')) return;
      document.getElementById(`slot-${selectedSlot}`).classList.remove('selected');
      selectedSlot = -1;
    });

    // Add page button & picker
    document.getElementById('add-page-btn').addEventListener('click', showPicker);
    document.getElementById('picker-backdrop').addEventListener('click', hidePicker);
    document.querySelectorAll('.picker-opt').forEach(btn => {
      btn.addEventListener('click', () => {
        addPage(parseInt(btn.dataset.template));
        hidePicker();
      });
    });

    // Single file upload for individual slot
    document.getElementById('single-file-input').addEventListener('change', async (e) => {
      if (e.target.files.length > 0 && pendingSlot >= 0) {
        try {
          const { img, url } = await loadImageFromFile(e.target.files[0]);
          photos[pendingSlot] = img;
          photoURLs[pendingSlot] = url;
          refreshSlot(pendingSlot);
          document.getElementById('hint-text').classList.remove('hidden');
        } catch (err) {
          console.error('Failed to load:', err);
        }
        pendingSlot = -1;
      }
      e.target.value = '';
    });

  } catch (err) {
    console.error('Init failed:', err);
    document.getElementById('album').innerHTML =
      `<p class="text-center text-red-400 py-20">로딩 실패. 서버를 확인해주세요.</p>`;
  }
}

document.addEventListener('DOMContentLoaded', init);
</script>
</body>
</html>
